#!/usr/bin/env bash

# Wrapper script for standalone bundle execution
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Get the current Ruby API version (e.g., "3.3.0" or "3.4.0")
RUBY_API_VERSION=$(ruby -e 'puts RbConfig::CONFIG["ruby_version"]')

# Find the bundled Ruby version directory
BUNDLED_VERSION=$(ls -1 "$DIR/bundle/ruby/" 2>/dev/null | head -n1)

# If current Ruby version directory doesn't exist, create a symlink to the bundled version
if [ -n "$BUNDLED_VERSION" ] && [ ! -d "$DIR/bundle/ruby/$RUBY_API_VERSION" ]; then
  ln -sf "$BUNDLED_VERSION" "$DIR/bundle/ruby/$RUBY_API_VERSION" 2>/dev/null || true
fi

# Run ruby with the standalone bundle setup
exec ruby -I"$DIR/bundle/bundler" -rsetup "$DIR/run_agent.rb" "$@"
